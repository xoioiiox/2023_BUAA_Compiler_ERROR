## 编译技术-设计文档

### 一、参考编译器介绍



### 二、编译器总体设计



### 三、词法分析设计

#### 设计

- `Lexer`类：
  - `getLines()`：用于将文件内容读入数组，以方便后续调用
  - `next()`：词法分析函数，通过不断读入字符，判断所构成的单词，并返回单词
  - `getAchar()`：从存好的数组中读入一字符
  - `retract()`：回退读入
- `LexType`类：
  - 枚举类，包含了所有单词类别码
- `Token`类：
  - 每一个单词是一个`Token`实例，其中记录了其类别码和具体值

#### 实际编码

- 整体架构同设计
- 为了快速匹配读入的单词类型，设计了`defMap`，将由字符组成的单词作为`key`，类别码作为`value`

### 四、语法分析设计

#### 设计

- `lexer`：
  - 新增`LexerIterator`类：
    - `read()`：读入单词
    - `preRead()`：预读单词，读指针位置不变
- `parser`：
  - 对于文法中的每一个非终结符都设计一个类，方便判断其类型
  - 构造对应的`parsexxx()`方法，递归下降解析语法成分

#### 实际编码

##### 类设计

为了结构清晰，设置了`declaration`, `expression`, `function`, `statement`四个包，分别管理对应类别的语法成分：

- `declaration`:
  - 对应非终结符类
  - `DeclParser`管理包内语法成分的解析
- `expression`:
  - 对应非终结符类
  - `CondParser`, `ExpParser`管理包内语法成分的解析
- `function`:
  - 对应非终结符类
  - `FuncDefParser`管理包内语法成分的解析
- `statement`:
  - 对应非终结符类
  - `BlockParser`, `StmtParser`管理包内语法成分的解析

##### 错误分析

在对`stmt`进行语法分析时，对于`Exp`的判断不全面，导致`runError`。

### 五、错误处理设计

#### 设计

- `error`: 
  - 错误类记录一条错误的行号，错误类型。
  - 错误表类内设计一容器存储编译过程中产生的错误，应能够按行号排序，不存储重复元素。
- `symbol`:
  - 需要新建符号类，记录符号的名称、行数等信息，根据符号类型的不同，还应记录不同特征。
  - 还需要新建一个符号表类，用于存储符号。还应在类中记录符号表的直接外层符号表，从而能够表示出不同符号表之间的关系。

#### 实际编码

##### 类设计

- 在实际编码中，根据题目要求，我选择使用`TreeSet< Error >`容器存储错误实例。先将错误全部存入该容器，最后按格式统一输出。
- 符号大体上可分为变量，常量，函数三大类，为了便于判断符号类型，同时清晰地存储不同类型符号应记录的不同特征值，我创建了`SymbolVar, SymbolCon, SymbolFunc`三个类，继承`Symbol`类。

##### 算法实现

根据题目给出的要求，逐一判断不同错误类别可能出现的位置，具体来说：

| 错误类别 | 错误检测实现                                                 |
| -------- | ------------------------------------------------------------ |
| a        | 在对`Stmt`进行语法分析时，解析出`formatString`，逐字符判断是否出现非法字符。 |
| b        | 在当前符号表内查找是否已存储同名符号，若是，则出现错误。     |
| c        | 从当前符号表出发，逐层向外层符号表查找，若查找到顶层仍未发现该符号，则出现错误。 |
| d        | 在函数符号类中存储函数参数个数，将其与函数调用时传入的参数个数比较，若不相同，则出现错误。 |
| e        | 在函数符号类中存储函数参数，同时在对应类中设计方法获取形参维度，将其与函数调用时传入的参数的维度比较，若存在不相同，则出现错误。 |
| f        | 在对返回语句进行分析时，若当前语句在无返回值函数中，且函数返回值不为空，则出现错误。 |
| g        | 直接取语句块的最后一条语句，若不为返回语句，则出现错误       |
| h        | 判断左值对应的符号是否为常数符号，若不是，则出现错误。       |
| i        | 判断对应位置是否存在`;`即可。                                |
| j        | 判断对应位置是否存在`)`即可。                                |
| k        | 判断对应位置是否存在`]`即可。                                |
| l        | 分别统计格式字符串，及右侧表达式的个数，若二者不相等，则出现错误。 |
| m        | 使用一个`inFor`变量记录当前语句外层for语句的层数，若`break`, `continue`语句出现时，`inFor`为0，则出现错误。 |

##### 错误分析

- 判断语句块内最后一句是否为返回语句时，忽略了语句块内为空的情况，导致`RunError`。
- 特别注意进入`block`要新建符号表，函数的语句块要将函数形参也加入符号表。

### 六、代码生成设计



### 七、代码优化设计